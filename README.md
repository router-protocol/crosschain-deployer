# Crosschain Deployer

## Components 

- Deployer contracts on EVM Chains 
- Deployer Contracts on Router Chain 

## Installation 

To compile the Cross Chain Deployer Rust contracts, navigate to the `rust` directory and run the build script:

```sh
cd rust
sh scripts/build.sh
```

This command will generate a WebAssembly (wasm) file in the `artifacts` directory.

To compile the Crosschain Solidity Contracts, navigate to the `solidity` directory and run the following commands: 

```sh
cd solidity
yarn 
npx hardhat clean
npx hardhat compile 
```

## Deploy Contracts on the Router Chain 
 
To upload and instantiate the router contract using the [router station tool](https://station.routerprotocol.com), you can use the provided scripts for an easy deployment process. Execute the following command to upload and instantiate the contract on the router station:

```sh
cd deployments
sh scripts/init.sh
```

When instantiating the Cross-Chain-Deployer cosmwasm contract, provide one constructor argument called `owner` in the instantiate message:

```json    
{ 
  "owner" : "<ownerAddress>" 
}
```

This `owner` address is used to perform administrative operations such as setting the contract address of deployer contracts present on each supporting chain.


### Deploy CrossChain Deployer on EVM chains 

After setting the `.env` parameters in the `solidity` folder, deploy the Deployer Contracts on EVM chains using the following commands: 

```sh
    npx hardhat DEPLOY_CROSSCHAIN_DEPLOYER --network <NETWORK NAME>
```

For example:
```sh
    npx hardhat DEPLOY_CROSSCHAIN_DEPLOYER --network polygonMumbai
    # after successful execution you will se output like this
    # Contract CrossChainDeployer has been deployed to: 0x65264210b86Fe3Fd8017D74B7125f57036d20514
```
The deployed address will be stored in the `deployments/deployment.json` file. Additional networks can be added to the Hardhat configuration.

### Register Deployer on router Chain 

Using router station use following commands to register deployer on router chain contracts 
```json
{
    "register_deployer":{
        "address": "0x65264210b86Fe3Fd8017D74B7125f57036d20514",
        "chain_id": "80001"
    }
}
```

You can change the `address` and `chain_id` to the appropriate values for your deployment. Note that this function can only be triggered by the owner.

### Deploying crosschain Contracts 

From the router station, you can use the following command to create EVM contracts on the desired chains: 

```json
{
  "deploy_contract": {
    "code": "<CONTRACT BYTE CODE>",
    "salt": "0x9d51687d04a49f2f9df398db0dedd78c9e543c8919f0c0024d04cd0ee8a87062",
    "constructor_args": [
      "<Contract Contractor arguments>"
    ],
    "chain_ids": [
      "80001"
    ],
    "gas_limits": [
      30000000
    ],
    "gas_prices": [
      300000000000
    ]
  }
}
```

You can change the `code`, `salt` and other parameters with the appropriate values for your contract. The `constructor_args`, `gas_prices` and `gas_limits` are specified in arrays corresponding to the respective `chain_ids`.

Once the EVM contract is deployed on the provided chains, an acknowledgement will be received. From the acknowledgement handler, a cross-contract function is called to the address that initially invoked the deployment instruction on the router chain. 

```json
{
  "set_custody_contracts": {
    "custody_contracts": [
      {
        "address": "<deplpyed evm contract address>",
        "chain_id": "<deployed contract chain_id>"
      }
    ]
  }
}
```

The caller can handle this function according to their requirement. Note that having this handler function is optional for the user/contract.

### Generation of bytecode for contract which has constructor parameters

In cases where a contract needs to be deployed with constructor parameters attached to it, you can use the following method with ethers.js:

```
let ConstuctorParams = ethers.utils.defaultAbiCoder.encode([< Data Types of consturctor elements>],[< Array of Constuctor Elements ]).slice(2)
let ExampleParams = ethers.utils.defaultAbiCoder.encode(['address'],['0x33B4A007EcC80Bc99578c18Da07da704c5403236']).slice(2) // Assuming constructor element has address 
let DeployedBytecode = `${contractByteCode}${ConstuctorParams}`
console.log(DeployedBytecode);

```

Use the deployed bytecode generated by this method to deploy contracts with constructor parameters.

### Fetching Deployer Address 

To fetch the deployer address from the router chain contract, use the following command:

```json
{
  "fetch_deployer": {
    "chain_id": 97
  }
}
```

To streamline the deployment process of our abstract account handler on EVM chains, we leverage the cross-chain deployer. This powerful tool simplifies the deployment of the abstract account handler, which is essential for efficiently managing accounts across different chains and enabling seamless cross-chain functionality. For comprehensive instructions and practical code examples, we invite you to explore the [Omniwallet](https://github.com/router-protocol/omniwallet) repository. There, you'll find detailed guidance on deploying the abstract account handler and harnessing its capabilities.
